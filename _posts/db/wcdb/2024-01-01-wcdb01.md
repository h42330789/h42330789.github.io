---
title: WCDB卡顿
author: 独孤流
date: 2024-01-01 02:04:00 +0800
categories: [db, wcdb]
tags: [db, wcdb]     # TAG names should always be lowercase
---

> ### 前言
> 从FMDB迁移到wcdb的第一时间，发现无比卡顿，后面搞定解决了，没注意到是什么原因，特记录下

场景：
好有数据库、群成员数据库分开管理
当添加或删除数据库时，由于两边数据不同步，导致好友关系没有及时同步，然后测试或产品提了一个相关的bug，在不了解业务场景的情况下直接对自己的所有群都进行更新了一遍，相当于 操作500个群+好有列表数据库，执行501个sql甚至更多，再叠加上使用了wcdb，使整个过程卡主了

反思：
1、要对业务更加熟悉专业
2、对产品或测试提出的不合理的需求，要在考虑性能的前提下才做，不然不能说做就做
3、针对大量群等操作数据要慎重
4、即使本地查询数据也要使用异步的方式，同步操作不当会卡主UI主线程
5、要对比下fmdb管理的sql与wcdb创建管理大量库、大量表的对比

`[IGNORE] Code:Busy SQL:PRAGMA journal_mode = 'WAL',Source:SQLite,Path:/var/mobile/Containers/Data/Application/xxx/Library/xxx/group_xxx/goupMember.sqlite,Message:database is locked`

FMDB:
```
// createTableInDatabase
let sqlCommand = "CREATE TABLE IF NOT EXISTS \xxx (ID INTEGER PRIMARY KEY,uid INTEGER, groupId INTEGER, isMyFriend INTEGER, ...)"
databaseQueue?.createTable(sql: sqlCommand)

// update
let commandString = "UPDATE \(tableName) SET isMyFriend = ? WHERE uid = ?"
                try db.executeUpdate(commandString, values: ["", isFriend])
```

WCDB
```
// create
database.create(table: "xxxx", of: WCDBMyGroupMemberDetail.self)
// update
database.run(transaction: {_ in
                let updateItem = WCDBMyGroupMemberDetail()
                updateItem.isMyFriend = isFriend ? 1 : 0
                try table.update(on: [WCDBMyGroupMemberDetail.Properties.isMyFriend], with: updateItem, where: WCDBMyGroupMemberDetail.Properties.uid == uid)
})
```
操作太耗时间